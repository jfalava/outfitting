# ========================================
# ZSH Configuration for macOS
# ========================================
# This file sources the universal base configuration and adds macOS-specific settings

# Source universal configuration
source ~/.zshrc-base

# ---- macOS-Specific VISUAL ----
export VISUAL='zed --wait'

# ---- macOS-Specific PATH Additions ----
# Add Homebrew to PATH (if installed)
path_prepend "/opt/homebrew/bin"

# Add paths in order of precedence
path_prepend "$HOME/.local/bin"
path_append "$HOME/go/bin"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
path_prepend "$PNPM_HOME"

# Bun
export BUN_INSTALL="$HOME/.bun"
path_prepend "$BUN_INSTALL/bin"

# Deno
export DENO_INSTALL="$HOME/.deno"
path_prepend "$DENO_INSTALL/bin"

# uv (Python)
path_append "$HOME/.local/share/uv/bin"

# OpenCode
path_prepend "$HOME/.opencode/bin"

# Cargo (Rust)
path_append "$HOME/.cargo/bin"

# ---- macOS-Specific Aliases ----
alias show='open'  # macOS equivalent of explorer
alias finder='open .'  # Open current directory in Finder

# ---- macOS-Specific Functions ----

# Find process using a port (macOS native)
port() {
    if [ -z "$1" ]; then
        echo "Usage: port <port_number>"
        return 1
    fi
    lsof -i ":$1"
}

# nix-darwin management functions
hm-sync() {
    echo "Syncing nix-darwin configuration from GitHub..."
    (set -o noglob; darwin-rebuild switch --flake 'github:jfalava/outfitting?dir=packages/aarch64-darwin#jfalava' "$@")
}

hm-switch() {
    echo "Applying nix-darwin configuration from GitHub..."
    darwin-rebuild switch --flake "github:jfalava/outfitting?dir=packages/aarch64-darwin#jfalava"
}

hm-switch-local() {
    if [ ! -d "$HOME/Workspace/outfitting" ]; then
        echo "Error: ~/Workspace/outfitting not found."
        echo ""
        echo "To use local development workflow:"
        echo "  1. Clone the repo:"
        echo "     git clone https://github.com/jfalava/outfitting.git ~/Workspace/outfitting"
        echo "  2. Make changes to ~/Workspace/outfitting/packages/aarch64-darwin/home.nix"
        echo "  3. Run: hm-switch-local"
        echo "  4. Commit and push changes (including flake.lock)"
        return 1
    fi

    echo "Applying nix-darwin configuration from local repo..."
    darwin-rebuild switch --flake "$HOME/Workspace/outfitting/packages/aarch64-darwin#jfalava"

    if git -C "$HOME/Workspace/outfitting" diff --quiet && git -C "$HOME/Workspace/outfitting" diff --cached --quiet; then
        echo ""
        echo "✓ No uncommitted changes - you're all set!"
    else
        echo ""
        echo "⚠ You have uncommitted changes in ~/Workspace/outfitting"
        echo "  Don't forget to commit and push to sync across machines:"
        echo "    cd ~/Workspace/outfitting"
        echo "    git add packages/aarch64-darwin/home.nix packages/aarch64-darwin/flake.lock"
        echo "    git commit -m 'Update nix-darwin config'"
        echo "    git push"
    fi
}

hm-update() {
    local repo="$HOME/Workspace/outfitting/packages/aarch64-darwin"

    if [ ! -d "$repo" ]; then
        echo "Error: $repo not found"
        echo ""
        echo "To use local updates:"
        echo "  git clone https://github.com/jfalava/outfitting.git ~/Workspace/outfitting"
        echo "  hm-update"
        return 1
    fi

    echo "Updating Nix packages from local repo..."
    cd "$repo" || return
    nix flake update
    darwin-rebuild switch --flake .#jfalava

    echo ""
    echo "✓ Nix packages updated locally"
    echo ""
    echo "Review changes:"
    git diff flake.lock
    echo ""
    echo "To deploy to GitHub and other machines:"
    echo "  cd ~/Workspace/outfitting"
    echo "  git add packages/aarch64-darwin/flake.lock"
    echo "  git commit -m 'chore: update nix packages'"
    echo "  git push"
    echo "  hm-sync  # on other machines to pull updates"
}

hm-rollback() {
    echo "Available generations:"
    darwin-rebuild --list-generations
    echo ""
    echo "To rollback to previous generation:"
    echo "  darwin-rebuild rollback"
}

hm-clean() {
    echo "Cleaning old nix-darwin generations..."
    sudo nix-collect-garbage -d
    echo "Cleaning complete!"
}

# System update
update-all() {
    echo "Updating Homebrew packages (if using Homebrew)..."
    if command -v brew &> /dev/null; then
        brew update && brew upgrade && brew cleanup
    fi

    echo -e "\nUpdating nix-darwin configuration..."
    hm-update
    local hm_exit=$?
    if [ $hm_exit -ne 0 ]; then
        echo "⚠ nix-darwin update failed"
        return $hm_exit
    fi

    echo -e "\nCleaning old generations..."
    hm-clean

    echo -e "\nUpdating global bun packages..."
    if command -v bun &> /dev/null; then
        bun update -g
    fi

    echo -e "\n✓ Update complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Review flake.lock changes"
    echo "  2. Commit: git add packages/aarch64-darwin/flake.lock && git commit -m 'chore: update nix packages'"
    echo "  3. Push: git push"
    echo "  4. Run 'hm-sync' on other machines"
}
