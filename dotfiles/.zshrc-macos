# ========================================
# ZSH Configuration for macOS
# ========================================
# This file sources the universal base configuration and adds macOS-specific settings

# Source universal configuration
source ~/.zshrc-base

# ---- macOS-Specific VISUAL ----
export VISUAL='zed --wait'

# ---- macOS-Specific PATH Additions ----
# Add Homebrew to PATH (if installed)
path_prepend "/opt/homebrew/bin"

# Add paths in order of precedence
path_prepend "$HOME/.local/bin"
path_append "$HOME/go/bin"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
path_prepend "$PNPM_HOME"

# Bun
export BUN_INSTALL="$HOME/.bun"
path_prepend "$BUN_INSTALL/bin"

# Deno
export DENO_INSTALL="$HOME/.deno"
path_prepend "$DENO_INSTALL/bin"

# uv (Python)
path_append "$HOME/.local/share/uv/bin"

# OpenCode
path_prepend "$HOME/.opencode/bin"

# Cargo (Rust)
path_append "$HOME/.cargo/bin"

# ---- macOS-Specific Aliases ----
alias show='open'  # macOS equivalent of explorer
alias finder='open .'  # Open current directory in Finder

# ---- macOS-Specific Functions ----

# Find process using a port (macOS native)
port() {
    if [ -z "$1" ]; then
        echo "Usage: port <port_number>"
        return 1
    fi
    lsof -i ":$1"
}

# Outfitting repository configuration functions
get_outfitting_repo() {
    local config_file="$HOME/.config/outfitting/repo-path"
    if [ -f "$config_file" ]; then
        cat "$config_file"
        return 0
    else
        return 1
    fi
}

set_outfitting_repo() {
    local repo_path="$1"
    if [ -z "$repo_path" ]; then
        echo "Error: No repository path provided"
        return 1
    fi

    # Convert to absolute path
    repo_path="$(cd "$repo_path" 2>/dev/null && pwd)" || {
        echo "Error: Path does not exist: $repo_path"
        return 1
    }

    local config_dir="$HOME/.config/outfitting"
    local config_file="$config_dir/repo-path"

    # Create config directory
    mkdir -p "$config_dir"

    # Store path
    echo "$repo_path" > "$config_file"
    chmod 600 "$config_file"

    echo "✓ Repository path set to: $repo_path"
    return 0
}

setup_outfitting_repo() {
    repo_path="$HOME/Workspace/outfitting"
    if [ ! -d "$repo_path" ]; then
        mkdir -p "$(dirname "$repo_path")"
        if ! git clone https://github.com/jfalava/outfitting.git "$repo_path"; then
            echo "Error: Failed to clone repository"
            return 1
        fi
    fi
    set_outfitting_repo "$repo_path"
    echo "✓ Repository ready: $repo_path"
}

# nix-darwin management functions - streamlined for personal use
hm-sync() {
    local repo_path=$(get_outfitting_repo) || { setup_outfitting_repo; repo_path=$(get_outfitting_repo); }
    cp "$repo_path/packages/aarch64-darwin/darwin.nix" ~/.nixpkgs/darwin-configuration.nix
    cp "$repo_path/packages/aarch64-darwin/home.nix" ~/.config/home-manager/
    darwin-rebuild switch
    echo "✓ Synced from $repo_path"
}

# Profile switching functions - streamlined for personal use
hm-personal() {
    local repo_path=$(get_outfitting_repo) || { setup_outfitting_repo; repo_path=$(get_outfitting_repo); }
    # Copy first, then modify the copies (don't touch source repo)
    cp "$repo_path/packages/aarch64-darwin/darwin.nix" ~/.nixpkgs/darwin-configuration.nix
    cp "$repo_path/packages/aarch64-darwin/home.nix" ~/.config/home-manager/
    # Portable sed approach (works on both BSD and GNU sed)
    sed 's/activeProfile = "[^"]*"/activeProfile = "personal"/' ~/.config/home-manager/home.nix > ~/.config/home-manager/home.nix.tmp && mv ~/.config/home-manager/home.nix.tmp ~/.config/home-manager/home.nix
    darwin-rebuild switch
    echo "✓ Personal profile active"
}

hm-work() {
    local repo_path=$(get_outfitting_repo) || { setup_outfitting_repo; repo_path=$(get_outfitting_repo); }
    # Copy first, then modify the copies (don't touch source repo)
    cp "$repo_path/packages/aarch64-darwin/darwin.nix" ~/.nixpkgs/darwin-configuration.nix
    cp "$repo_path/packages/aarch64-darwin/home.nix" ~/.config/home-manager/
    # Portable sed approach (works on both BSD and GNU sed)
    sed 's/activeProfile = "[^"]*"/activeProfile = "work"/' ~/.config/home-manager/home.nix > ~/.config/home-manager/home.nix.tmp && mv ~/.config/home-manager/home.nix.tmp ~/.config/home-manager/home.nix
    darwin-rebuild switch
    echo "✓ Work profile active (AWS, K8s, etc.)"
}

# Quick profile check
hm-profile() {
    local current=$(grep 'activeProfile' ~/.config/home-manager/home.nix 2>/dev/null | cut -d'"' -f2)
    if [[ -n "$1" ]]; then
        case "$1" in
            personal|work) hm-"$1" ;;
            *) echo "Usage: hm-profile <personal|work>" ;;
        esac
    else
        echo "Current: $current"
    fi
}

hm-switch() {
    echo "Applying nix-darwin configuration..."
    darwin-rebuild switch
}

hm-switch-local() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    echo "Applying nix-darwin configuration from local repo..."
    
    # Copy configuration files
    cp "$repo_path/packages/aarch64-darwin/darwin.nix" ~/.nixpkgs/darwin-configuration.nix
    cp "$repo_path/packages/aarch64-darwin/home.nix" ~/.config/home-manager/
    
    # Apply configuration
    darwin-rebuild switch

    if git -C "$repo_path" diff --quiet && git -C "$repo_path" diff --cached --quiet; then
        echo ""
        echo "✓ No uncommitted changes - you're all set!"
    else
        echo ""
        echo "⚠ You have uncommitted changes in $repo_path"
        echo "  Don't forget to commit and push to sync across machines:"
        echo "    cd $repo_path"
        echo "    git add packages/aarch64-darwin/darwin.nix packages/aarch64-darwin/home.nix"
        echo "    git commit -m 'Update nix-darwin config'"
        echo "    git push"
    fi
}

hm-update() {
    echo "Updating Nix channels and nix-darwin..."
    
    # Update channels (like brew update)
    nix-channel --update
    
    # Apply updated configuration
    darwin-rebuild switch

    echo ""
    echo "✓ Nix packages updated successfully!"
    echo ""
    echo "Packages are now floating with nixpkgs-unstable channel (like Homebrew)"
}

hm-rollback() {
    echo "Available generations:"
    darwin-rebuild --list-generations
    echo ""
    echo "To rollback to previous generation:"
    echo "  darwin-rebuild rollback"
}

hm-clean() {
    echo "Cleaning old nix-darwin generations..."
    sudo nix-collect-garbage -d
    echo "Cleaning complete!"
}

# Quick system update
update-all() {
    command -v brew >/dev/null && brew update && brew upgrade && brew cleanup
    hm-update && hm-clean
    command -v bun >/dev/null && bun update -g
    echo "✓ System updated"
}