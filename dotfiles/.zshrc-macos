# ========================================
# ZSH Configuration for macOS
# ========================================

# Source universal configuration
source ~/.zshrc-base

# ---- macOS-Specific VISUAL ----
export VISUAL='zed --wait'

# ---- macOS-Specific PATH Additions ----
# Add paths in order of precedence
path_prepend "$HOME/.local/bin"
path_append "$HOME/go/bin"

# Add Applications folder to PATH
path_prepend "/Applications/"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
path_prepend "$PNPM_HOME"

# Bun
export BUN_INSTALL="$HOME/.bun"
path_prepend "$BUN_INSTALL/bin"

# Deno
export DENO_INSTALL="$HOME/.deno"
path_prepend "$DENO_INSTALL/bin"

# uv (Python)
path_append "$HOME/.local/share/uv/bin"

# OpenCode
path_prepend "$HOME/.opencode/bin"

# Cargo (Rust)
path_append "$HOME/.cargo/bin"

# ---- Smart App Bundle PATH Detection ----
# Auto-add VS Code-like app bundles that have bin directories to PATH
for app_dir in /Applications/*.app; do
    if [[ -d "$app_dir/Contents/Resources/app/bin" ]]; then
        path_prepend "$app_dir/Contents/Resources/app/bin"
    fi
done

# ---- macOS-Specific Aliases ----
alias show='open'  # macOS equivalent of explorer
alias finder='open .'  # Open current directory in Finder

# Nix-darwin rebuild aliases with proper quoting for flake syntax
alias drb='darwin-rebuild build --flake ".#macos" --impure'
alias drs='sudo darwin-rebuild switch --flake ".#macos" --impure'
alias dru='sudo darwin-rebuild switch --flake ".#macos" --upgrade --impure'
alias drd='darwin-rebuild switch --flake ".#macos" --dry-run --impure'
alias drl='darwin-rebuild --list-generations'
alias drr='sudo darwin-rebuild rollback'

# Quick nix commands
alias nix-clean='sudo nix-collect-garbage -d'
alias nix-search='nix search nixpkgs'
alias nix-shell='nix shell nixpkgs#'

# Outfit rebuild short aliases
alias or='outfit-rebuild'
alias obr='outfit-rebuild build'
alias osr='outfit-rebuild switch'
alias otr='outfit-rebuild test'
alias odr='outfit-rebuild dry'
alias our='outfit-rebuild upgrade'

# Zed editor aliases
alias zed='/Applications/Zed.app/Contents/MacOS/cli -n'
alias z.='/Applications/Zed.app/Contents/MacOS/cli -n .'
alias zed-wait='/Applications/Zed.app/Contents/MacOS/cli -n --wait'

# ---- macOS-Specific Functions ----

# Quick nix package test (creates temporary shell with package)
nix-test() {
    if [ -z "$1" ]; then
        echo "Usage: nix-test <package-name>"
        echo "Example: nix-test bat"
        return 1
    fi
    echo "Testing package: $1"
    nix shell "nixpkgs#$1" --command "$1" --version
}

# Search and install test (search then test)
nix-try() {
    if [ -z "$1" ]; then
        echo "Usage: nix-try <search-term>"
        echo "Example: nix-try ripgrep"
        return 1
    fi
    echo "Searching for packages matching: $1"
    nix search nixpkgs "$1"
    echo ""
    echo "To test a specific package: nix-test <package-name>"
}

# Find process using a port (macOS native)
port() {
    if [ -z "$1" ]; then
        echo "Usage: port <port_number>"
        return 1
    fi
    lsof -i ":$1"
}

# Outfitting repository configuration functions
get_outfitting_repo() {
    local config_file="$HOME/.config/outfitting/repo-path"
    if [ -f "$config_file" ]; then
        cat "$config_file"
        return 0
    else
        return 1
    fi
}

set_outfitting_repo() {
    local repo_path="$1"
    if [ -z "$repo_path" ]; then
        echo "Error: No repository path provided"
        return 1
    fi

    # Convert to absolute path
    repo_path="$(cd "$repo_path" 2>/dev/null && pwd)" || {
        echo "Error: Path does not exist: $repo_path"
        return 1
    }

    local config_dir="$HOME/.config/outfitting"
    local config_file="$config_dir/repo-path"

    # Create config directory
    mkdir -p "$config_dir"

    # Store path
    echo "$repo_path" > "$config_file"
    chmod 600 "$config_file"

    echo "✓ Repository path set to: $repo_path"
    return 0
}



# nix-darwin management functions
hm-sync() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlinks are set up correctly
    local darwin_target="$repo_path/packages/aarch64-darwin/darwin.nix"
    local hm_target="$repo_path/packages/aarch64-darwin"

    if [ ! -L ~/.nixpkgs/darwin-configuration.nix ] || [ "$(readlink -f ~/.nixpkgs/darwin-configuration.nix)" != "$(readlink -f "$darwin_target")" ]; then
        echo "✓ Creating/updating symlink: ~/.nixpkgs/darwin-configuration.nix → $darwin_target"
        mkdir -p ~/.nixpkgs
        ln -sfn "$darwin_target" ~/.nixpkgs/darwin-configuration.nix
    fi

    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$hm_target")" ]; then
        echo "✓ Creating/updating symlink: ~/.config/home-manager → $hm_target"
        ln -sfn "$hm_target" ~/.config/home-manager
    fi

     sudo darwin-rebuild switch --flake "$repo_path/packages/aarch64-darwin"
     echo "✓ Synced from $repo_path"
 }

hm-switch() {
     echo "Applying nix-darwin configuration..."
     sudo darwin-rebuild switch
 }

hm-switch-local() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    echo "Applying nix-darwin configuration from local repo..."

    # Ensure symlinks are set up correctly
    local darwin_target="$repo_path/packages/aarch64-darwin/darwin.nix"
    local hm_target="$repo_path/packages/aarch64-darwin"

    if [ ! -L ~/.nixpkgs/darwin-configuration.nix ] || [ "$(readlink -f ~/.nixpkgs/darwin-configuration.nix)" != "$(readlink -f "$darwin_target")" ]; then
        mkdir -p ~/.nixpkgs
        ln -sfn "$darwin_target" ~/.nixpkgs/darwin-configuration.nix
    fi

    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$hm_target")" ]; then
        ln -sfn "$hm_target" ~/.config/home-manager
    fi

     # Apply configuration
     sudo darwin-rebuild switch

    if git -C "$repo_path" diff --quiet && git -C "$repo_path" diff --cached --quiet; then
        echo ""
        echo "✓ No uncommitted changes - you're all set!"
    else
        echo ""
        echo "⚠ You have uncommitted changes in $repo_path"
        echo "  Don't forget to commit and push to sync across machines:"
        echo "    cd $repo_path"
        echo "    git add packages/aarch64-darwin/"
        echo "    git commit -m 'Update nix-darwin config'"
        echo "    git push"
    fi
}

hm-update() {
     local repo_path=$(get_outfitting_repo) || {
         echo "Error: Repository location not configured."
         echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
         return 1
     }
 
     # Ensure symlinks are set up correctly
     local darwin_target="$repo_path/packages/aarch64-darwin/darwin.nix"
     local hm_target="$repo_path/packages/aarch64-darwin"
 
     if [ ! -L ~/.nixpkgs/darwin-configuration.nix ] || [ "$(readlink -f ~/.nixpkgs/darwin-configuration.nix)" != "$(readlink -f "$darwin_target")" ]; then
         mkdir -p ~/.nixpkgs
         ln -sfn "$darwin_target" ~/.nixpkgs/darwin-configuration.nix
     fi
 
     if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$hm_target")" ]; then
         ln -sfn "$hm_target" ~/.config/home-manager
     fi
 
     echo "Updating flake inputs and nix-darwin..."
 
     # Update flake lock file (requires sudo to write to flake.lock)
     sudo nix flake update --flake "$repo_path/packages/aarch64-darwin"
 
     # Apply updated configuration
     sudo darwin-rebuild switch --flake "$repo_path/packages/aarch64-darwin"
 
     echo ""
     echo "✓ Nix packages updated successfully!"
     echo ""
     echo "Flake lock file updated with latest nixpkgs"
 }

hm-rollback() {
    echo "Available generations:"
    darwin-rebuild --list-generations
    echo ""
    echo "To rollback to previous generation:"
    echo "  darwin-rebuild rollback"
}

hm-clean() {
    echo "Cleaning old nix-darwin generations..."
    sudo nix-collect-garbage -d
    echo "Cleaning complete!"
}

# Quick system update
update-all() {
     # Request elevation at the start
     sudo -v || return 1
     
     hm-update && hm-clean
     command -v bun >/dev/null && bun update -g
 }

# Quick nix-darwin rebuild from anywhere in the system
outfit-rebuild() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlinks exist
    local darwin_target="$repo_path/packages/aarch64-darwin/darwin.nix"
    local hm_target="$repo_path/packages/aarch64-darwin"

    if [ ! -L ~/.nixpkgs/darwin-configuration.nix ]; then
        mkdir -p ~/.nixpkgs
        ln -sfn "$darwin_target" ~/.nixpkgs/darwin-configuration.nix
    fi

    if [ ! -L ~/.config/home-manager ]; then
        ln -sfn "$hm_target" ~/.config/home-manager
    fi

    cd "$repo_path/packages/aarch64-darwin" || return 1

    case "${1:-switch}" in
        build|b)
            echo "Building nix-darwin configuration..."
            darwin-rebuild build --flake ".#macos" --impure
            ;;
        switch|s)
            echo "Applying nix-darwin configuration..."
            sudo darwin-rebuild switch --flake ".#macos" --impure
            ;;
        test|t)
            echo "Testing nix-darwin configuration..."
            darwin-rebuild build --flake ".#macos" && echo "Build successful - ready to switch"
            ;;
        dry|d)
            echo "Dry-run check..."
            darwin-rebuild switch --flake ".#macos" --dry-run --impure
            ;;
        upgrade|u)
            echo "Upgrading packages and applying..."
            sudo darwin-rebuild switch --flake ".#macos" --upgrade
            ;;
        *)
            echo "Usage: outfit-rebuild [build|switch|test|dry|upgrade]"
            echo "  build/b    - Build configuration only"
            echo "  switch/s   - Build and apply configuration (default)"
            echo "  test/t     - Test build only"
            echo "  dry/d      - Dry-run to see what would change"
            echo "  upgrade/u  - Upgrade packages and apply"
            ;;
    esac

    # Return to original directory
    cd - > /dev/null || return 0
}

# Zed editor configuration functions
# Quick open functions that ACTUALLY open new windows
zcd() {
    if [ -z "$1" ]; then
        /Applications/Zed.app/Contents/MacOS/cli -n .
    else
        /Applications/Zed.app/Contents/MacOS/cli -n "$1"
    fi
}

# Open NEW Zed window
znew() {
    /Applications/Zed.app/Contents/MacOS/cli -n
}

# Open recent projects (opens in new window)
zrecent() {
    /Applications/Zed.app/Contents/MacOS/cli -n
}
