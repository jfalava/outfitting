# ========================================
# ZSH Configuration for WSL/Linux
# ========================================

# Source universal configuration
source ~/.zshrc-base

# ---- WSL VISUAL ----
export VISUAL='zed'

# ---- WSL PATH Additions ----
path_prepend "$HOME/.local/bin"

# pnpm
path_prepend "$PNPM_HOME"

# Bun
export BUN_INSTALL="$HOME/.bun"
path_prepend "$BUN_INSTALL/bin"

# Deno
export DENO_INSTALL="$HOME/.deno"
path_prepend "$DENO_INSTALL/bin"

# uv (Python)
path_append "$HOME/.local/share/uv/bin"

# OpenCode
path_prepend "$HOME/.opencode/bin"

# Cargo (Rust)
path_append "$HOME/.cargo/bin"

# AmpCode
path_append "$HOME/.amp/bin"

# Git AI
path_append "$HOME/.git-ai/bin"

# Go bin directory - add at the end to ensure it takes precedence over Windows paths
export PATH="$HOME/go/bin:$PATH"

# ---- WSL-Specific Aliases ----
alias explorer='/mnt/c/WINDOWS/explorer.exe'

# ---- WSL-Specific Functions ----

# Find process using a port (with ss fallback for WSL)
port() {
    if [ -z "$1" ]; then
        echo "Usage: port <port_number>"
        return 1
    fi
    sudo lsof -i ":$1" || sudo ss -tulpn | grep ":$1"
}

# Outfitting repository configuration functions
get_outfitting_repo() {
    local config_file="$HOME/.config/outfitting/repo-path"
    if [ -f "$config_file" ]; then
        cat "$config_file"
        return 0
    else
        return 1
    fi
}

set_outfitting_repo() {
    local repo_path="$1"
    if [ -z "$repo_path" ]; then
        echo "Error: No repository path provided"
        return 1
    fi

    # Convert to absolute path
    repo_path="$(cd "$repo_path" 2>/dev/null && pwd)" || {
        echo "Error: Path does not exist: $repo_path"
        return 1
    }

    local config_dir="$HOME/.config/outfitting"
    local config_file="$config_dir/repo-path"

    # Create config directory
    mkdir -p "$config_dir"

    # Store path
    echo "$repo_path" > "$config_file"
    chmod 600 "$config_file"

    echo "✓ Repository path set to: $repo_path"
    return 0
}



# Home Manager management functions - streamlined for personal use
hm-sync() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlink exists and points to correct location
    local target="$repo_path/packages/x64-linux"
    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$target")" ]; then
        echo "✓ Creating/updating symlink: ~/.config/home-manager → $target"
        ln -sfn "$target" ~/.config/home-manager
    fi

    home-manager switch --flake "$repo_path/packages/x64-linux" --impure
    echo "✓ Synced from $repo_path"
}

# Profile switching functions - using flake composition
hm-personal() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlink exists
    local target="$repo_path/packages/x64-linux"
    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$target")" ]; then
        ln -sfn "$target" ~/.config/home-manager
    fi

    home-manager switch --flake "$repo_path/packages/x64-linux#jfalava-personal" --impure
    echo "✓ Personal profile active"
}

hm-work() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlink exists
    local target="$repo_path/packages/x64-linux"
    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$target")" ]; then
        ln -sfn "$target" ~/.config/home-manager
    fi

    home-manager switch --flake "$repo_path/packages/x64-linux#jfalava-work" --impure
    echo "✓ Work profile active"
}

# Quick profile check - detects current flake configuration
hm-profile() {
    if [[ -n "$1" ]]; then
        case "$1" in
            personal|work) hm-"$1" ;;
            *) echo "Usage: hm-profile <personal|work>" ;;
        esac
    else
        # Check which flake configuration is currently active
        local repo_path=$(get_outfitting_repo 2>/dev/null) || { echo "Repository not configured"; return 1; }

        # Try to detect current profile by checking for work-specific packages
        if command -v terraform &>/dev/null && command -v kubectl &>/dev/null; then
            echo "Current: work"
        else
            echo "Current: personal"
        fi
    fi
}

hm-switch() {
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlink exists
    local target="$repo_path/packages/x64-linux"
    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$target")" ]; then
        ln -sfn "$target" ~/.config/home-manager
    fi

    echo "Applying current Home Manager configuration..."
    home-manager switch --flake "$repo_path/packages/x64-linux" --impure
}

hm-update() {
    echo "Updating flake inputs and Home Manager..."
    local repo_path=$(get_outfitting_repo) || {
        echo "Error: Repository location not configured."
        echo "Run 'set_outfitting_repo /path/to/outfitting' to configure."
        return 1
    }

    # Ensure symlink exists
    local target="$repo_path/packages/x64-linux"
    if [ ! -L ~/.config/home-manager ] || [ "$(readlink -f ~/.config/home-manager)" != "$(readlink -f "$target")" ]; then
        ln -sfn "$target" ~/.config/home-manager
    fi

    # Update flake inputs (updates flake.lock)
    nix flake update --flake "$repo_path/packages/x64-linux"

    # Apply updated configuration using current profile
    # Try to detect current profile and maintain it
    if command -v aws >/dev/null 2>&1 && command -v k9s >/dev/null 2>&1; then
        echo "Detected work profile, maintaining work configuration..."
        home-manager switch --flake "$repo_path/packages/x64-linux#jfalava-work" --impure
    else
        echo "Using personal profile..."
        home-manager switch --flake "$repo_path/packages/x64-linux#jfalava-personal" --impure
    fi

    echo ""
    echo "✓ Nix packages updated successfully!"
    echo ""
    echo "Flake lock file updated with latest nixpkgs"
}

hm-rollback() {
    echo "Available generations:"
    home-manager generations
    echo ""
    echo "To rollback, run the activation script of your desired generation (listed above)"
}

hm-clean() {
    echo "Cleaning old Home Manager generations..."
    nix-collect-garbage -d
    echo "Cleaning complete!"
}

# Update all global Bun packages
bun-update-global() {
    if ! command -v bun >/dev/null; then
        echo "Bun not installed, skipping..."
        return 0
    fi

    echo ""
    echo "Updating global Bun packages..."

    local packages
    packages=$(bun pm ls -g 2>/dev/null | awk '/^[└├]── / {sub(/^[└├]── /, ""); match($0, /@[0-9]+\.[0-9]+\.[0-9]+$/); print substr($0, 1, RSTART-1)}')

    if [ -z "$packages" ]; then
        echo "No global Bun packages found"
        return 0
    fi

    echo "Found global packages:"
    echo "$packages"
    echo ""

    local updated=0
    while IFS= read -r pkg; do
        pkg=$(echo "$pkg" | tr -d ' ')
        if [ -n "$pkg" ]; then
            echo -n "Updating $pkg... "
            if bun update -g "$pkg" >/dev/null 2>&1; then
                echo "✓"
                ((updated++))
            else
                echo "no update"
            fi
        fi
    done <<< "$packages"

    echo "Updated $updated global Bun package(s)"
}

# Quick system update
update-all() {
     # Request elevation at the start
     sudo -v || return 1

     echo ""
     echo "=== Updating System (APT) ==="
     local apt_output
     apt_output=$(sudo apt update 2>&1 && sudo apt upgrade -y 2>&1 && sudo apt autoremove -y 2>&1)

     echo "$apt_output" | grep -E '^(Reading|Get|Preparing|Unpacking|Setting|Processing)' || echo "No APT updates"
     echo "✓ APT packages updated"

     echo ""
     echo "=== Updating Nix/Home Manager ==="
     hm-update && hm-clean

     echo ""
     echo "=== Updating Global Bun Packages ==="
     bun-update-global

     echo ""
     echo "✓ System updated successfully"
 }

remote-update() {
    curl -L https://wsl.jfa.dev | bash -s -- --update-only
}

# SSH Agent - Persistent across shell sessions
SSH_AGENT_FILE="$HOME/.ssh/agent-env"

if [ -f "$SSH_AGENT_FILE" ]; then
    eval "$(cat "$SSH_AGENT_FILE")" > /dev/null 2>&1
fi

if [ -z "$SSH_AUTH_SOCK" ] || [ ! -S "$SSH_AUTH_SOCK" ]; then
    ssh_agent_output="$(ssh-agent -s)"
    echo "$ssh_agent_output" > "$SSH_AGENT_FILE"
    eval "$ssh_agent_output" > /dev/null 2>&1
    chmod 600 "$SSH_AGENT_FILE"
fi

unset SSH_AGENT_FILE
