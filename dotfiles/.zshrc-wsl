# ========================================
# ZSH Configuration for WSL/Linux
# ========================================

# Source universal configuration
source ~/.zshrc-base

# ---- WSL/Linux-Specific VISUAL ----
export VISUAL='zed --wait'

# ---- WSL/Linux-Specific PATH Additions ----
path_prepend "$HOME/.local/bin"
path_append "$HOME/go/bin"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
path_prepend "$PNPM_HOME"

# Bun
export BUN_INSTALL="$HOME/.bun"
path_prepend "$BUN_INSTALL/bin"

# Deno
export DENO_INSTALL="$HOME/.deno"
path_prepend "$DENO_INSTALL/bin"

# uv (Python)
path_append "$HOME/.local/share/uv/bin"

# OpenCode
path_prepend "$HOME/.opencode/bin"

# Cargo (Rust)
path_append "$HOME/.cargo/bin"

# ---- WSL-Specific Aliases ----
alias explorer='/mnt/c/WINDOWS/explorer.exe'

# ---- WSL-Specific Functions ----

# Find process using a port (with ss fallback for WSL)
port() {
    if [ -z "$1" ]; then
        echo "Usage: port <port_number>"
        return 1
    fi
    sudo lsof -i ":$1" || sudo ss -tulpn | grep ":$1"
}

# Outfitting repository configuration functions
get_outfitting_repo() {
    local config_file="$HOME/.config/outfitting/repo-path"
    if [ -f "$config_file" ]; then
        cat "$config_file"
        return 0
    else
        return 1
    fi
}

set_outfitting_repo() {
    local repo_path="$1"
    if [ -z "$repo_path" ]; then
        echo "Error: No repository path provided"
        return 1
    fi

    # Convert to absolute path
    repo_path="$(cd "$repo_path" 2>/dev/null && pwd)" || {
        echo "Error: Path does not exist: $repo_path"
        return 1
    }

    local config_dir="$HOME/.config/outfitting"
    local config_file="$config_dir/repo-path"

    # Create config directory
    mkdir -p "$config_dir"

    # Store path
    echo "$repo_path" > "$config_file"
    chmod 600 "$config_file"

    echo "✓ Repository path set to: $repo_path"
    return 0
}

setup_outfitting_repo() {
    echo "Outfitting repository location not configured."
    echo ""

    # Offer choices
    echo "Where would you like to keep the outfitting repository?"
    echo ""
    echo "  1) Default location: ~/Workspace/outfitting"
    echo "  2) Choose custom location"
    echo "  3) Specify existing clone"
    echo "  s) Skip for now (use remote flake only)"
    echo ""

    while true; do
        read -r -p "Select option (1-3, s): " choice

        case "$choice" in
            1)
                repo_path="$HOME/Workspace/outfitting"
                break
                ;;
            2)
                read -e -p "Enter custom path: " repo_path
                if [ -z "$repo_path" ]; then
                    echo "Error: No path provided"
                    continue
                fi
                break
                ;;
            3)
                read -e -p "Enter existing clone path: " repo_path
                if [ -z "$repo_path" ]; then
                    echo "Error: No path provided"
                    continue
                fi
                break
                ;;
            s|S)
                echo "Skipped. You can set up local repository later with: setup-outfitting-repo"
                return 0
                ;;
            *)
                echo "Invalid option. Please choose 1-3 or s."
                continue
                ;;
        esac
    done

    # Handle the repository setup
    if [ ! -d "$repo_path" ]; then
        echo "Directory doesn't exist. Creating: $repo_path"
        mkdir -p "$(dirname "$repo_path")"

        echo "Cloning outfitting repository..."
        if git clone https://github.com/jfalava/outfitting.git "$repo_path"; then
            echo "✓ Repository cloned successfully"
        else
            echo "✗ Failed to clone repository"
            return 1
        fi
    elif [ ! -d "$repo_path/.git" ]; then
        echo "Error: Directory exists but is not a git repository: $repo_path"
        return 1
    else
        echo "✓ Using existing repository at: $repo_path"
    fi

    # Store the configuration
    if set_outfitting_repo "$repo_path"; then
        echo ""
        echo "✓ Repository location configured successfully!"
        echo "  You can now use: hm-sync, hm-switch, and other local commands"
        echo "  To change location later, run: setup-outfitting-repo"
        return 0
    else
        return 1
    fi
}

# Home Manager management functions
hm-sync() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    echo "Syncing Home Manager configuration from local repo..."
    home-manager switch --flake "$repo_path/packages/x64-linux#jfalava" "$@"

    # Check for uncommitted changes and prompt to push
    if ! git -C "$repo_path" diff --quiet || ! git -C "$repo_path" diff --cached --quiet; then
        echo ""
        echo "⚠ You have uncommitted changes in $repo_path"
        echo "  Would you like to commit and push these changes? (y/N) "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo ""
            echo "Committing changes..."
            git -C "$repo_path" add packages/x64-linux/home.nix packages/x64-linux/flake.lock
            echo "Enter commit message (or press Enter for default): "
            read -r commit_msg
            if [ -z "$commit_msg" ]; then
                commit_msg="Update home-manager config"
            fi
            git -C "$repo_path" commit -m "$commit_msg"
            echo ""
            echo "Pushing to GitHub..."
            git -C "$repo_path" push
            echo "✓ Changes pushed successfully!"
        else
            echo "  Changes remain uncommitted. To push later:"
            echo "    cd $repo_path"
            echo "    git add packages/x64-linux/home.nix packages/x64-linux/flake.lock"
            echo "    git commit -m 'Update home-manager config'"
            echo "    git push"
        fi
    else
        echo ""
        echo "✓ No uncommitted changes - you're all set!"
    fi
}

hm-switch() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    echo "Applying Home Manager configuration from local repo..."
    home-manager switch --flake "$repo_path/packages/x64-linux#jfalava"
}

hm-switch-local() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    echo "Applying Home Manager configuration from local repo..."
    home-manager switch --flake "$repo_path/packages/x64-linux#jfalava"

    if git -C "$repo_path" diff --quiet && git -C "$repo_path" diff --cached --quiet; then
        echo ""
        echo "✓ No uncommitted changes - you're all set!"
    else
        echo ""
        echo "⚠ You have uncommitted changes in $repo_path"
        echo "  Don't forget to commit and push to sync across machines:"
        echo "    cd $repo_path"
        echo "    git add packages/x64-linux/home.nix packages/x64-linux/flake.lock"
        echo "    git commit -m 'Update home-manager config'"
        echo "    git push"
    fi
}

hm-update() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    local repo="$repo_path/packages/x64-linux"

    echo "Updating Nix packages from local repo..."
    cd "$repo" || return
    nix flake update
    home-manager switch --flake .#jfalava

    echo ""
    echo "✓ Nix packages updated locally"
    echo ""
    echo "Review changes:"
    git diff flake.lock
    echo ""
    echo "To deploy to GitHub and other machines:"
    echo "  cd $repo_path"
    echo "  git add packages/x64-linux/flake.lock"
    echo "  git commit -m 'chore: update nix packages'"
    echo "  git push"
    echo "  hm-sync  # on other machines to pull updates"
}

hm-rollback() {
    echo "Available generations:"
    home-manager generations
    echo ""
    echo "To rollback, run the activation script of your desired generation (listed above)"
}

hm-clean() {
    echo "Cleaning old Home Manager generations..."
    nix-collect-garbage -d
    echo "Cleaning complete!"
}

# System update
update-all() {
    local repo_path
    repo_path=$(get_outfitting_repo) || {
        echo "Error: Outfitting repository location not configured."
        echo ""
        setup_outfitting_repo || return 1
        repo_path=$(get_outfitting_repo)
    }

    echo "Updating APT packages..."
    sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y

    echo -e "\nUpdating Home Manager configuration..."
    hm-update
    local hm_exit=$?
    if [ $hm_exit -ne 0 ]; then
        echo "⚠ Home Manager update failed"
        return $hm_exit
    fi

    echo -e "\nCleaning old generations..."
    hm-clean

    echo -e "\nUpdating global bun packages..."
    if command -v bun >/dev/null; then
        bun update -g
    fi

    echo -e "\n✓ Update complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Review flake.lock changes"
    echo "  2. Commit: git add packages/x64-linux/flake.lock && git commit -m 'chore: update nix packages'"
    echo "  3. Push: git push"
    echo "  4. Run 'hm-sync' on other machines"
}

remote-update() {
    curl -L https://wsl.jfa.dev | bash -s -- --update-only
}

# SSH Agent - Persistent across shell sessions
SSH_AGENT_FILE="$HOME/.ssh/agent-env"

if [ -f "$SSH_AGENT_FILE" ]; then
    eval "$(cat "$SSH_AGENT_FILE")" > /dev/null 2>&1
fi

if [ -z "$SSH_AUTH_SOCK" ] || [ ! -S "$SSH_AUTH_SOCK" ]; then
    ssh_agent_output="$(ssh-agent -s)"
    echo "$ssh_agent_output" > "$SSH_AGENT_FILE"
    eval "$ssh_agent_output" > /dev/null 2>&1
    chmod 600 "$SSH_AGENT_FILE"
fi

unset SSH_AGENT_FILE
